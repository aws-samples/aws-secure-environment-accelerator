
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the AWS Secure Environment Accelerator">
      
      
        <meta name="author" content="Amazon Web Services">
      
      
        <link rel="canonical" href="https://awssea.github.io/developer/development/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.9">
    
    
      
        <title>Development Guide - AWS Secure Environment Accelerator</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2b4465f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/pdf-print.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#development-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AWS Secure Environment Accelerator" class="md-header__button md-logo" aria-label="AWS Secure Environment Accelerator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWS Secure Environment Accelerator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Development Guide
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/aws-secure-environment-accelerator/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/asea
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Secure Environment Accelerator" class="md-nav__button md-logo" aria-label="AWS Secure Environment Accelerator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    AWS Secure Environment Accelerator
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/aws-secure-environment-accelerator/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/asea
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../about/">About</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pricing/sample_pricing/" class="md-nav__link">
        Pricing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../installation/">Installation & Upgrades</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Installation & Upgrades" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Installation & Upgrades
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/upgrades/" class="md-nav__link">
        Upgrades
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/existing-orgs/" class="md-nav__link">
        Existing Orgs & Accounts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/design/" class="md-nav__link">
        Design Decisions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/services-list/" class="md-nav__link">
        Deployed Services List
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../operations/">Operations & Troubleshooting</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Operations & Troubleshooting" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Operations & Troubleshooting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/system-overview/" class="md-nav__link">
        System Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/common-tasks/" class="md-nav__link">
        Common Tasks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/operations-import-ALZAccount/" class="md-nav__link">
        Import Existing ALZ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../guides/fortigate/">Fortigate</a>
          
            <label for="__nav_6_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Fortigate" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          Fortigate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/fortigate/public-facing-workload-via-fortigate/" class="md-nav__link">
        Expose Public Facing Workload
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Developer Guide</a>
          
            <label for="__nav_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Development Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Development Guide
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    Project Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installer-stack" class="md-nav__link">
    Installer Stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup-stack" class="md-nav__link">
    Initial Setup Stack
  </a>
  
    <nav class="md-nav" aria-label="Initial Setup Stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#codebuild-and-prebuilt-docker-image" class="md-nav__link">
    CodeBuild and Prebuilt Docker Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-data-to-phase-steps-and-phase-stacks" class="md-nav__link">
    Passing Data to Phase Steps and Phase Stacks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-steps-and-phase-stacks" class="md-nav__link">
    Phase Steps and Phase Stacks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-outputs-to-ssm-parameter-store" class="md-nav__link">
    Store outputs to SSM Parameter Store
  </a>
  
    <nav class="md-nav" aria-label="Store outputs to SSM Parameter Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phases-and-deployments" class="md-nav__link">
    Phases and Deployments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-outputs-between-phases" class="md-nav__link">
    Passing Outputs between Phases
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoupling-configuration-from-constructs" class="md-nav__link">
    Decoupling Configuration from Constructs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libraries-tools" class="md-nav__link">
    Libraries &amp; Tools
  </a>
  
    <nav class="md-nav" aria-label="Libraries &amp; Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cdk-assume-role-plugin" class="md-nav__link">
    CDK Assume Role Plugin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cdk-api" class="md-nav__link">
    CDK API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-sdk-wrappers" class="md-nav__link">
    AWS SDK Wrappers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-file-parsing" class="md-nav__link">
    Configuration File Parsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-stack-outputs" class="md-nav__link">
    Creating Stack Outputs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-resources" class="md-nav__link">
    Custom Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workarounds" class="md-nav__link">
    Workarounds
  </a>
  
    <nav class="md-nav" aria-label="Workarounds">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stacks-with-same-name-in-different-regions" class="md-nav__link">
    Stacks with Same Name in Different Regions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-development" class="md-nav__link">
    Local Development
  </a>
  
    <nav class="md-nav" aria-label="Local Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-installer-stack" class="md-nav__link">
    Local Installer Stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-initial-setup-stack" class="md-nav__link">
    Local Initial Setup Stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-stacks" class="md-nav__link">
    Phase Stacks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validating-immutable-property-changes-and-logical-id-changes" class="md-nav__link">
    Validating Immutable Property Changes and Logical ID Changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-cdk" class="md-nav__link">
    Upgrade CDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tech-stack/" class="md-nav__link">
        Tech Stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../best-practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contributing-guidelines/" class="md-nav__link">
        How to Contribute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../release-process/" class="md-nav__link">
        Release Process
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8">
          Architectures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architectures" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Architectures
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_1" type="checkbox" id="__nav_8_1" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../architectures/pbmm/">PBMM</a>
          
            <label for="__nav_8_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="PBMM" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          PBMM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architectures/pbmm/accounts/" class="md-nav__link">
        Account Structure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architectures/pbmm/network/" class="md-nav__link">
        Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architectures/pbmm/auth/" class="md-nav__link">
        Authentication & Authorization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architectures/pbmm/logging/" class="md-nav__link">
        Logging and Monitoring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architectures/pbmm/diagrams/" class="md-nav__link">
        Architecture Diagrams
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../workshops/">Workshops</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Workshops" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Workshops
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../schema/">Configuration File Schema</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Configuration File Schema" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Configuration File Schema
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11">
          Contributing & Governance
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing & Governance" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Contributing & Governance
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/aws-samples/aws-secure-environment-accelerator/blob/main/CONTRIBUTING.md" class="md-nav__link">
        None
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    Project Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installer-stack" class="md-nav__link">
    Installer Stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup-stack" class="md-nav__link">
    Initial Setup Stack
  </a>
  
    <nav class="md-nav" aria-label="Initial Setup Stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#codebuild-and-prebuilt-docker-image" class="md-nav__link">
    CodeBuild and Prebuilt Docker Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-data-to-phase-steps-and-phase-stacks" class="md-nav__link">
    Passing Data to Phase Steps and Phase Stacks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-steps-and-phase-stacks" class="md-nav__link">
    Phase Steps and Phase Stacks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-outputs-to-ssm-parameter-store" class="md-nav__link">
    Store outputs to SSM Parameter Store
  </a>
  
    <nav class="md-nav" aria-label="Store outputs to SSM Parameter Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phases-and-deployments" class="md-nav__link">
    Phases and Deployments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-outputs-between-phases" class="md-nav__link">
    Passing Outputs between Phases
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoupling-configuration-from-constructs" class="md-nav__link">
    Decoupling Configuration from Constructs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libraries-tools" class="md-nav__link">
    Libraries &amp; Tools
  </a>
  
    <nav class="md-nav" aria-label="Libraries &amp; Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cdk-assume-role-plugin" class="md-nav__link">
    CDK Assume Role Plugin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cdk-api" class="md-nav__link">
    CDK API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-sdk-wrappers" class="md-nav__link">
    AWS SDK Wrappers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-file-parsing" class="md-nav__link">
    Configuration File Parsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-stack-outputs" class="md-nav__link">
    Creating Stack Outputs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-resources" class="md-nav__link">
    Custom Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workarounds" class="md-nav__link">
    Workarounds
  </a>
  
    <nav class="md-nav" aria-label="Workarounds">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stacks-with-same-name-in-different-regions" class="md-nav__link">
    Stacks with Same Name in Different Regions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-development" class="md-nav__link">
    Local Development
  </a>
  
    <nav class="md-nav" aria-label="Local Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-installer-stack" class="md-nav__link">
    Local Installer Stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-initial-setup-stack" class="md-nav__link">
    Local Initial Setup Stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-stacks" class="md-nav__link">
    Phase Stacks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validating-immutable-property-changes-and-logical-id-changes" class="md-nav__link">
    Validating Immutable Property Changes and Logical ID Changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-cdk" class="md-nav__link">
    Upgrade CDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/aws-samples/aws-secure-environment-accelerator/edit/master/docs/developer/development.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="development-guide">Development Guide<a class="headerlink" href="#development-guide" title="Permanent link">&para;</a></h1>
<p>There are different types of projects in this monorepo.</p>
<ol>
<li>Projects containing CDK code that compiles to CloudFormation templates and deploy to AWS using the CDK toolkit;</li>
<li>Projects containing runtime code that is used by the CDK code to deploy Lambda functions;</li>
<li>Projects containing reusable code; both for use by the CDK code and/or runtime code.</li>
</ol>
<p>The CDK code either deploys Accelerator-management resources or Accelerator-managed resources. See the <a href="../../operations/">Operations Guide</a> for the distinction between Accelerator-management and Accelerator-managed resources.</p>
<p>The only language used in the project is TypeScript and exceptionally JavaScript. We do not write CloudFormation templates, only CDK code.</p>
<p>When we want to enable functionality in a managed account we try to</p>
<ol>
<li>use native CloudFormation/CDK resource to enable the functionality;</li>
<li>create a custom resource to enable the functionality; or</li>
<li>lastly create a new step in the <code>Initial Setup</code> state machine to enable the functionality.</li>
</ol>
<h2 id="project-structure">Project Structure<a class="headerlink" href="#project-structure" title="Permanent link">&para;</a></h2>
<p>The folder structure of the project is as follows:</p>
<ul>
<li><code>src/installer/cdk</code>: See <a href="#installer-stack">Installer Stack</a>;</li>
<li><code>src/core/cdk</code>: See <a href="#initial-setup-stack">Initial Setup Stack</a>;</li>
<li><code>src/core/runtime</code> See <a href="#initial-setup-stack">Initial Setup Stack</a> and <a href="#phase-steps-and-phase-stacks">Phase Steps and Phase Stacks</a>;</li>
<li><code>src/deployments/runtime</code> See <a href="#phase-steps-and-phase-stacks">Phase Steps and Phase Stacks</a>;</li>
<li><code>src/deployments/cdk</code>: See <a href="#phase-steps-and-phase-stacks">Phase Steps and Phase Stacks</a>;</li>
<li><code>src/lib/accelerator-cdk</code>: See <a href="#libraries--tools">Libraries &amp; Tools</a>;</li>
<li><code>src/lib/cdk-constructs</code>: See <a href="#libraries--tools">Libraries &amp; Tools</a>;</li>
<li><code>src/lib/cdk-plugin-assume-role</code>: See <a href="#cdk-assume-role-plugin">CDK Assume Role Plugin</a>.</li>
<li><code>src/lib/common-config</code>: See <a href="#libraries--tools">Libraries &amp; Tools</a>;</li>
<li><code>src/lib/common-outputs</code>: See <a href="#libraries--tools">Libraries &amp; Tools</a>;</li>
<li><code>src/lib/common-types</code>: See <a href="#libraries--tools">Libraries &amp; Tools</a>;</li>
<li><code>src/lib/common</code>: See <a href="#libraries--tools">Libraries &amp; Tools</a>;</li>
<li><code>src/lib/custom-resources/**/cdk</code>: See <a href="#custom-resources">Custom Resources</a>;</li>
<li><code>src/lib/custom-resources/**/runtime</code>: See <a href="#custom-resources">Custom Resources</a>;</li>
</ul>
<h2 id="installer-stack">Installer Stack<a class="headerlink" href="#installer-stack" title="Permanent link">&para;</a></h2>
<p>Read the <a href="../../operations/#installer-stack">Operations Guide</a> first before reading this section. This section is a technical addition to the section in the Operations Guide.</p>
<p>As stated in the Operations Guide, the <code>Installer</code> stack is responsible for installing the <code>Initial Setup</code> stack. It is an Accelerator-management resource. The main resource in the <code>Installer</code> stack is the <code>ASEA-Installer</code> CodePipeline. The CodePipeline uses this GitHub repository as source action and runs CDK in a CodeBuild step to deploy the <code>Initial Setup</code> stack.</p>
<pre><code class="language-typescript">new codebuild.PipelineProject(stack, 'InstallerProject', {
  buildSpec: codebuild.BuildSpec.fromObject({
    version: '0.2',
    phases: {
      install: {
        'runtime-versions': {
          nodejs: 14,
        },
        // The flag '--unsafe-perm' is necessary to run pnpm scripts in Docker
        commands: ['npm install --global pnpm@6.2.3', 'pnpm install --unsafe-perm --frozen-lockfile'],
      },
      pre_build: {
        // The flag '--unsafe-perm' is necessary to run pnpm scripts in Docker
        commands: ['pnpm recursive run build --unsafe-perm'],
      },
      build: {
        commands: [
          'cd src/core/cdk',
          // Bootstrap the environment for use by CDK
          'pnpx cdk bootstrap --require-approval never',
          // Deploy the Initial Setup stack
          'pnpx cdk deploy --require-approval never',
        ],
      },
    },
  }),
});
</code></pre>
<p>When the CodePipeline finishes deploying the <code>Initial Setup</code> stack, it starts a Lambda function that starts the execution of the <code>Initial Setup</code> stack's main state machine.</p>
<p>The <code>Initial Setup</code> stack deployment receives environment variables from the CodePipeline's CodeBuild step. The most notable environment variables are:</p>
<ul>
<li><code>ACCELERATOR_STATE_MACHINE_NAME</code>: The <code>Initial Setup</code> will use this name for the main state machine. So it is the <code>Installer</code> stack that decides the name of the main state machine. This way we can confidently start the main state machine of the <code>Initial Setup</code> stack from the CodePipeline;</li>
<li><code>ENABLE_PREBUILT_PROJECT</code>: See <a href="#codebuild-and-prebuilt-docker-image">Prebuilt Docker Image</a>.</li>
</ul>
<h2 id="initial-setup-stack">Initial Setup Stack<a class="headerlink" href="#initial-setup-stack" title="Permanent link">&para;</a></h2>
<p>Read <a href="../../operations/#initial-setup-stack">Operations Guide</a> first before reading this section. This section is a technical addition to the section in the Operations Guide.</p>
<p>As stated in the Operations Guide, the <code>Initial Setup</code> stack consists of a state machine, named <code>ASEA-MainStateMachine_sm</code>, which executes steps to create the Accelerator-managed stacks and resources in the managed accounts. It is an Accelerator-management resource.</p>
<p>The <code>Initial Setup</code> stack is defined in the <code>src/core/cdk</code> folder.</p>
<p>The <code>Initial Setup</code> stack is similar to the <code>Installer</code> stack, as in that it runs a CodeBuild project to deploy others stacks using CDK. In case of the <code>Initial Setup</code> stack</p>
<ul>
<li>we use a AWS Step Functions State Machine to run steps instead of using a CodePipeline;</li>
<li>we deploy multiple stacks, called <code>Phase</code> stacks, in Accelerator-managed accounts. These <code>Phase</code> stacks contain Accelerator-managed resources.</li>
</ul>
<p>In order to install these <code>Phase</code> stacks in Accelerator-managed accounts, we need access to those accounts. We create a stack set in the Organization Management (root) account that has instances in all Accelerator-managed accounts. This stack set contains what we call the <code>PipelineRole</code>.</p>
<p>The code for the steps in the state machine is in <code>src/core/runtime</code>. All the steps are in different files but are compiled into a single file. We used to compile all the steps separately but we would hit a limit in the amount of parameters in the generated CloudFormation template. Each step would have its own CDK asset that would introduce three new parameters. We quickly reached the limit of 60 parameters in a CloudFormation template and decided to compile the steps into a single file and use it across all different Lambda functions.</p>
<h3 id="codebuild-and-prebuilt-docker-image">CodeBuild and Prebuilt Docker Image<a class="headerlink" href="#codebuild-and-prebuilt-docker-image" title="Permanent link">&para;</a></h3>
<p>The CodeBuild project that deploys the different <code>Phase</code> stacks is constructed using the <code>CdkDeployProject</code> or <code>PrebuiltCdkDeployProject</code> based on the value of the environment variable <code>ENABLE_PREBUILT_PROJECT</code>.</p>
<p>The first, <code>CdkDeployProject</code> constructs a CodeBuild project that copies this whole Github repository as a ZIP file to S3 using <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-s3-assets-readme.html">CDK S3 assets</a>. This ZIP file is then used as source for the CodeBuild project. When the CodeBuild project executes, it runs <code>pnpm recursive install</code> which in turn will run all <code>prepare</code> scripts in all <code>package.json</code> files in the project -- as described in section <a href="#334-cdk-code-dependency-on-lambda-function-code">CDK Code Dependency on Lambda Function Code</a>.</p>
<p>After installing the dependencies, the CodeBuild project deploys the <code>Phase</code> stacks.</p>
<pre><code class="language-bash">cd src/deployments/cdk
sh codebuild-deploy.sh
</code></pre>
<p>We have more than 50 workspace projects in the monorepo with a <code>prepare</code> script, so the <code>pnpm recursive install</code> step can take some time. Also, the CodeBuild project will run for each deployed <code>Phase</code> stack in each Accelerator-managed account.</p>
<p>This is where the <code>PrebuiltCdkDeployProject</code> CodeBuild project comes in. The <code>PrebuiltCdkDeployProject</code> contains a Docker image that contains the whole project in the <code>/app</code> directory and has all the dependencies already installed.</p>
<pre><code class="language-Dockerfile">FROM node:12-alpine3.11
# Install the package manager
RUN npm install --global pnpm
RUN mkdir /app
WORKDIR /app
# Copy over the project root to the /app directory
ADD . /app/
# Install the dependencies
RUN pnpm install --unsafe-perm --frozen-lockfile
# Build all Lambda function runtime code
RUN pnpm recursive run build --unsafe-perm
</code></pre>
<p>When this CodeBuild project executes, it uses the Docker image as base -- the dependencies are already installed -- and runs the same commands as the <code>CdkDeployProject</code> to deploy the <code>Phase</code> stacks.</p>
<h3 id="passing-data-to-phase-steps-and-phase-stacks">Passing Data to Phase Steps and Phase Stacks<a class="headerlink" href="#passing-data-to-phase-steps-and-phase-stacks" title="Permanent link">&para;</a></h3>
<p>Some steps in the state machine write data to Amazon DynamoDB. This data is necessary to deploy the <code>Phase</code> stacks later on. At one time this data was written to Secrets Manager and/or S3, these mechanisms were deemed ineffective due to object size limitations or consistency challenges and were all eventually migrated to DynamoDB.</p>
<ul>
<li><code>Load Accounts</code> step: This step finds the Accelerator-managed accounts in AWS Organizations and stores the account key -- the key of the account in <code>mandatory-account-configs</code> or <code>workload-account-configs</code> object in the Accelerator config -- and account ID and other useful information in the <code>ASEA-Parameters</code> table, <code>accounts/#</code> key and <code>accounts-items-count</code> key;</li>
<li><code>Load Organizations</code> step: More or less the same as the <code>Load Accounts</code> step but for organizational units in AWS Organizations and stores the values in the <code>ASEA-Parameters</code> table, <code>organizations</code> key;</li>
<li><code>Load Limits</code> step: This step requests limit increases for Accelerator-managed accounts and stores the current limits in the the <code>ASEA-Parameters</code> table, <code>limits</code> key.</li>
<li><code>Store Phase X Output</code>: This step loads stack outputs from all existing <code>Phase</code> stacks and stores the outputs in the DynamoDB table <code>ASEA-Outputs</code>.</li>
</ul>
<p>Other data is passed through environment variables:</p>
<ul>
<li><code>ACCELERATOR_NAME</code>: The name of the Accelerator;</li>
<li><code>ACCELERATOR_PREFIX</code>: The prefix for all named Accelerator-managed resources;</li>
<li><code>ACCELERATOR_EXECUTION_ROLE_NAME</code>: The name of the execution role in the Accelerator-managed accounts. This is the <code>PipelineRole</code> we created using stack sets.</li>
</ul>
<h2 id="phase-steps-and-phase-stacks">Phase Steps and Phase Stacks<a class="headerlink" href="#phase-steps-and-phase-stacks" title="Permanent link">&para;</a></h2>
<p>Read <a href="../../operations/#initial-setup-stack">Operations Guide</a> first before reading this section. This section is a technical addition to the <em>Deploy Phase X</em> sections in the Operations Guide.</p>
<p>The <code>Phase</code> stacks contain the Accelerator-managed resources. The reason the deployment of Accelerator-managed resources is split into different phases is because there cannot be cross account/region references between CloudFormation stacks. See <a href="#cross-accountregion-references">Cross-Account/Region References</a>.</p>
<p>The <code>Phase</code> stacks are deployed by a CodeBuild project in the <code>Initial Setup</code> stack as stated in the previous paragraphs. The CodeBuild project executes the <code>codebuild-deploy.sh</code> script. See <a href="https://github.com/aws-samples/aws-secure-environment-accelerator/blob/main/src/core/cdk/src/initial-setup.ts#L132"><code>initial-setup.ts</code></a>.</p>
<p>The <a href="https://github.com/aws-samples/aws-secure-environment-accelerator/blob/main/src/deployments/cdk/codebuild-deploy.sh"><code>codebuild-deploy.sh</code></a> script executes the <code>cdk.ts</code> file.</p>
<p>The <a href="https://github.com/aws-samples/aws-secure-environment-accelerator/blob/main/src/deployments/cdk/cdk.ts"><code>cdk.ts</code></a> file is meant as a replacement for the <code>cdk</code> CLI command. To deploy a phase stack you would <strong>not</strong> run <code>pnpx cdk deploy</code> but <code>cdk.sh --phase 1</code>. See <a href="#cdk-api">CDK API</a> for more information why we use the CDK API instead of using the CDK CLI.</p>
<p>The <code>cdk.ts</code> command parses command line arguments and creates all the <code>cdk.App</code> for all accounts and regions for the given <code>--phase</code>. When you pass the <code>--region</code> or <code>--account-key</code> command, all the <code>cdk.App</code> for all accounts and regions will still be created, except that only the <code>cdk.App</code>s matching the parameters will be deployed. This behavior could be optimized in the future. See <a href="#stacks-with-same-name-in-different-regions">Stacks with Same Name in Different Regions</a> for more information why we're creating multiple <code>cdk.App</code>s.</p>
<h2 id="store-outputs-to-ssm-parameter-store">Store outputs to SSM Parameter Store<a class="headerlink" href="#store-outputs-to-ssm-parameter-store" title="Permanent link">&para;</a></h2>
<p>Customers need the CloudFormation outputs of resources that are created by the accelerator in order to deploy their own resources in AWS. eg. vpcId in shared-network account to create an ec2 instance, etc.</p>
<p>This step loads the stack outputs from our DynamoDB Table <code>ASEA-Outputs</code> and stores as key value pairs in SSM Parameter Store in each account.</p>
<p>Example values are</p>
<ul>
<li>/ASEA/network/vpc/1/name =&gt; Endpoint</li>
<li>/ASEA/network/vpc/1/id =&gt; vpc-XXXXXXXXXX</li>
</ul>
<p><code>ASEA-Outputs-Utils</code> DynamoDB Table is used extensively to maintain same index irrespective of configuration changes.</p>
<p>This allows customers to reliably build Infrastructure as Code (IaC) which depends on accelerator deployed objects like VPC's, security groups, subnets, ELB's, KMS keys, IAM users and policies. Rather than making the parameters dependent on object names, we used an indexing scheme, which we maintain and don't update as a customers configuration changes. We have attempted to keep the index values consistent across accounts (based on the config file), such that when code is propoted through the SDLC cycle from Dev to Test to Prod, the input parameters to the IaC scripts do not need to be updated, the App subnet, for example, will have the same index value in all accounts.</p>
<h3 id="phases-and-deployments">Phases and Deployments<a class="headerlink" href="#phases-and-deployments" title="Permanent link">&para;</a></h3>
<p>The <code>cdk.ts</code> file calls the <code>deploy</code> method in the <code>apps/app.ts</code>. This <code>deploy</code> method loads the Accelerator configuration, accounts, organizations from DynamoDB; loads the stack outputs from Amazon DynamoDB; and loads required environment variables.</p>
<pre><code class="language-typescript">/**
 * Input to the `deploy` method of a phase.
 */
export interface PhaseInput {
  // The config.json file
  acceleratorConfig: AcceleratorConfig;
  // Auxiliary class to construct stacks
  accountStacks: AccountStacks;
  // The list of accounts, their key in the configuration file and their ID
  accounts: Account[];
  // The parsed environment variables
  context: Context;
  // The list of stack outputs from previous phases
  outputs: StackOutput[];
  // Auxiliary class to manage limits
  limiter: Limiter;
}
</code></pre>
<p>It is important to note that no configuration is hard-coded. The CloudFormation templates are generated by CDK and the CDK constructs are created according to the configuration file. Changes to the configuration will change the CDK construct tree and that will result in a different CloudFormation template that is deployed.</p>
<p>The different phases are defined in <code>apps/phase-x.ts</code>. Historically we created all CDK constructs in the <code>phase-x.ts</code> files. After a while the <code>phase-x.ts</code> files started to get too big and we moved to separating the logic into separate deployments. Every logical component has a separate folder in the <code>deployments</code> folder. Every <code>deployment</code> consists of so-called steps. Separate steps are put in loaded in phases.</p>
<p>For example, take the <code>deployments/defaults</code> deployment. The deployment consists of two steps, i.e. <code>step-1.ts</code> and <code>step-2.ts</code>. <code>deployments/defaults/step-1.ts</code> is created in <code>apps/phase-0.ts</code> and <code>deployments/defaults/step-2.ts</code> is created in <code>apps/phase-1.ts</code>. You can find more details about what happens in each phase in the <a href="../../operations/">Operations Guide</a>.</p>
<p><code>apps/phase-0.ts</code></p>
<pre><code class="language-typescript">export async function deploy({ acceleratorConfig, accountStacks, accounts, context }: PhaseInput) {
  // Create defaults, e.g. S3 buckets, EBS encryption keys
  const defaultsResult = await defaults.step1({
    acceleratorPrefix: context.acceleratorPrefix,
    accountStacks,
    accounts,
    config: acceleratorConfig,
  });
</code></pre>
<p><code>apps/phase-1.ts</code></p>
<pre><code class="language-typescript">export async function deploy({ acceleratorConfig, accountStacks, accounts, outputs }: PhaseInput) {
  // Find the central bucket in the outputs
  const centralBucket = CentralBucketOutput.getBucket({
    accountStacks,
    config: acceleratorConfig,
    outputs,
  });

  // Find the log bucket in the outputs
  const logBucket = LogBucketOutput.getBucket({
    accountStacks,
    config: acceleratorConfig,
    outputs,
  });

  // Find the account buckets in the outputs
  const accountBuckets = await defaults.step2({
    accounts,
    accountStacks,
    centralLogBucket: logBucket,
    config: acceleratorConfig,
  });
}
</code></pre>
<h3 id="passing-outputs-between-phases">Passing Outputs between Phases<a class="headerlink" href="#passing-outputs-between-phases" title="Permanent link">&para;</a></h3>
<p>The CodeBuild step that is responsible for deploying a <code>Phase</code> stack runs in the Organization Management (root) account. We wrote a CDK plugin that allows the CDK deploy step to assume a role in the Accelerator-managed account and create the CloudFormation <code>Phase</code> stack in the managed account. See <a href="#cdk-assume-role-plugin">CDK Assume Role Plugin</a>.</p>
<p>After a <code>Phase-X</code> is deployed in all Accelerator-managed accounts, a step in the <code>Initial Setup</code> state machine collects all the <code>Phase-X</code> stack outputs in all Accelerator-managed accounts and regions and stores theses outputs in DynamoDB.</p>
<p>Then the next <code>Phase-X+1</code> deploys using the outputs from the previous <code>Phase-X</code> stacks.</p>
<p>See <a href="#creating-stack-outputs">Creating Stack Outputs</a> for helper constructs to create outputs.</p>
<h3 id="decoupling-configuration-from-constructs">Decoupling Configuration from Constructs<a class="headerlink" href="#decoupling-configuration-from-constructs" title="Permanent link">&para;</a></h3>
<p>At the start of the project we created constructs that had tight coupling to the Accelerator config structure. The properties to instantiate a construct would sometimes have a reference to an Accelerator-specific interface. An example of this is the <code>Vpc</code> construct in <code>src/deployments/cdk/common/vpc.ts</code>.</p>
<p>Later on in the project we started decoupling the Accelerator config from the construct properties. Good examples are in <code>src/lib/cdk-constructs/</code>.</p>
<p>Decoupling the configuration from the constructs improves reusability and robustness of the codebase.</p>
<h2 id="libraries-tools">Libraries &amp; Tools<a class="headerlink" href="#libraries-tools" title="Permanent link">&para;</a></h2>
<h3 id="cdk-assume-role-plugin">CDK Assume Role Plugin<a class="headerlink" href="#cdk-assume-role-plugin" title="Permanent link">&para;</a></h3>
<p>At the time of writing, CDK does not support cross-account deployments of stacks. It is possible however to write a CDK plugin and implement your own credential loader for cross-account deployment.</p>
<p>We wrote a CDK plugin that can assume a role into another account. In our case, the Organization Management (root) account will assume the <code>PipelineRole</code> in an Accelerator-managed account to deploy stacks.</p>
<h3 id="cdk-api">CDK API<a class="headerlink" href="#cdk-api" title="Permanent link">&para;</a></h3>
<p>We use the internal CDK API to deploy the <code>Phase</code> stacks instead of the CDK CLI for the following reasons:</p>
<ul>
<li>It allows us to deploy multiple stacks in parallel;</li>
<li>Disable stack termination before destroying a stack;</li>
<li>Delete a stack after it initially failed to create;</li>
<li>Deploy multiple apps at the same time -- see <a href="#stacks-with-same-name-in-different-regions">Stacks with Same Name in Different Regions</a>.</li>
</ul>
<p>The helper class <code>CdkToolkit</code> in <code>toolkit.ts</code> wraps around the CDK API.</p>
<p>The risk of using the CDK API directly is that the CDK API can change at any time. There is no stable API yet. When upgrading the CDK version, the <code>CdkToolkit</code> wrapper might need to be adapted.</p>
<h3 id="aws-sdk-wrappers">AWS SDK Wrappers<a class="headerlink" href="#aws-sdk-wrappers" title="Permanent link">&para;</a></h3>
<p>You can find <code>aws-sdk</code> wrappers in the <code>src/lib/common/src/aws</code> folder. Most of the classes and functions just wrap around <code>aws-sdk</code> classes and implement promises and exponential backoff to retryable errors. Other classes, like <code>Organizations</code> have additional functionality such as listing all the organizational units in an organization in the function <code>listOrganizationalUnits</code>.</p>
<p>Please use the <code>aws-sdk</code> wrappers throughout the project or write an additional wrapper when necessary.</p>
<h3 id="configuration-file-parsing">Configuration File Parsing<a class="headerlink" href="#configuration-file-parsing" title="Permanent link">&para;</a></h3>
<p>The configuration file is defined and validated using the <a href="https://github.com/gcanti/io-ts"><code>io-ts</code></a> library. See <code>src/lib/common-config/src/index.ts</code>. In case any changes need to be made to the configuration file parsing, this is the place to be.</p>
<p>We wrap a class around the <code>AcceleratorConfig</code> type that contains additional helper functions. You can add your own additional helper functions.</p>
<h4 id="acceleratornametagger"><code>AcceleratorNameTagger</code><a class="headerlink" href="#acceleratornametagger" title="Permanent link">&para;</a></h4>
<p><code>AcceleratorNameTagger</code> is a <a href="https://docs.aws.amazon.com/cdk/latest/guide/aspects.html">CDK aspect</a> that sets the name tag on specific resources based on the construct ID of the resource.</p>
<p>The following example illustrates its purpose.</p>
<pre><code class="language-typescript">const stack = new cdk.Stack();
new ec2.CfnVpc(stack, 'SharedNetwork', {});
Aspects.of(stack).add(new AcceleratorNameTagger());
</code></pre>
<p>The example above synthesizes to the following CloudFormation template.</p>
<pre><code class="language-yaml">Resources:
  SharedNetworkAB7JKF7:
    Properties:
      Tags:
        - Key: Name
          Value: SharedNetwork_vpc
</code></pre>
<h4 id="acceleratorstack"><code>AcceleratorStack</code><a class="headerlink" href="#acceleratorstack" title="Permanent link">&para;</a></h4>
<p><code>AcceleratorStack</code> is a class that extends <code>cdk.Stack</code> and adds the <code>Accelerator</code> tag to all resources in the stack. It also applies the aspect <code>AcceleratorNameTagger</code>.</p>
<p>It is also used by the <code>accelerator-name-generator.ts</code> functions to find the name of the <code>Accelerator</code>.</p>
<h4 id="name-generator">Name Generator<a class="headerlink" href="#name-generator" title="Permanent link">&para;</a></h4>
<p>The <code>accelerator-name-generator.ts</code> file contains methods that create names for resources that are optionally prefixed with the Accelerator name, and optionally suffixed with a hash based on the path of the resource, the account ID and region of the stack.</p>
<p>The functions should be used to create pseudo-random names for IAM roles, KMS keys, key pairs and log groups.</p>
<h4 id="accountstacks"><code>AccountStacks</code><a class="headerlink" href="#accountstacks" title="Permanent link">&para;</a></h4>
<p><code>AccountStacks</code> is a class that manages the creation of an <code>AcceleratorStack</code> based on a given account key and region. If an account with the given account key cannot be found in the accounts object -- which is loaded by <code>apps/app.ts</code> then no stack will be created. This class is used extensively throughout the phases and deployment steps.</p>
<pre><code class="language-typescript">export async function step1(props: CertificatesStep1Props) {
  const { accountStacks, centralBucket: centralBucket, config } = props;

  for (const { accountKey, certificates } of config.getCertificateConfigs()) {
    if (certificates.length === 0) {
      continue;
    }

    const accountStack = accountStacks.tryGetOrCreateAccountStack(accountKey);
    if (!accountStack) {
      console.warn(`Cannot find account stack ${accountKey}`);
      continue;
    }

    for (const certificate of certificates) {
      createCertificate({
        centralBucket,
        certificate,
        scope: accountStack,
      });
    }
  }
}
</code></pre>
<h4 id="vpc-and-importedvpc"><code>Vpc</code> and <code>ImportedVpc</code><a class="headerlink" href="#vpc-and-importedvpc" title="Permanent link">&para;</a></h4>
<p><code>Vpc</code> is an interface in the <code>src/lib/cdk-constructs/src/vpc/vpc.ts</code> file that attempts to define an interface for a VPC. The goal of the interface is to be implemented by a <code>cdk.Construct</code> that implements the interface. This CDK issue provides more background [https://github.com/aws/aws-cdk/issues/5927].</p>
<p>Another goal of the interface is to provide an interface on top of imported VPC outputs. This is what the <code>ImportedVpc</code> class implements. The class loads outputs from VPC in a previous phase and implements the <code>Vpc</code> interface on top of those outputs.</p>
<h4 id="limiter"><code>Limiter</code><a class="headerlink" href="#limiter" title="Permanent link">&para;</a></h4>
<p>So far we haven't talked about limits yet. There is a step in the <code>Initial Setup</code> state machine that requests limit increases according to the desired limits in the configuration file. The step saves the current limits to the <code>limits</code> key in the DynamoDB table <code>ASEA-Parameters</code>. The <code>apps/app.ts</code> file loads the limits and passes them as an input to the phase deployment.</p>
<p>The <code>Limiter</code> class helps keeps track of resource we create and prevents exceeding these limits.</p>
<pre><code class="language-typescript">for (const { ouKey, accountKey, vpcConfig, deployments } of acceleratorConfig.getVpcConfigs()) {
  if (!limiter.create(accountKey, Limit.VpcPerRegion, region)) {
    console.log(`Skipping VPC &quot;${vpcConfig.name}&quot; deployment.`);
    console.log(`Reached maximum VPCs per region for account &quot;${accountKey}&quot; and region &quot;${region}&quot;`);
    continue;
  }

  createVpc({ ouKey, accountKey, vpcConfig });
}
</code></pre>
<blockquote>
<p><em>Action Item:</em> This functionality could be redesigned to scan all the constructs in a <code>cdk.App</code> and remove resource that are exceeding any limits.</p>
</blockquote>
<h3 id="creating-stack-outputs">Creating Stack Outputs<a class="headerlink" href="#creating-stack-outputs" title="Permanent link">&para;</a></h3>
<p>Initially we would create stack outputs like this:</p>
<pre><code class="language-typescript">new cdk.CfnOutput(stack, 'BucketOutput', {
  value: bucket.bucketArn,
});
</code></pre>
<p>But then we'd get a lot of outputs in a stack. We started some outputs together using JSON. This allowed us to store structured data inside the stack outputs.</p>
<pre><code class="language-typescript">new JsonOutputValue(stack, 'Output', {
  type: 'FirewallInstanceOutput',
  value: {
    instanceId: instance.instanceId,
    name: firewallConfig.name,
    az,
  },
});
</code></pre>
<p>Using the solution above, we'd not have type checking when reading or writing outputs. That's what the class <code>StructuredOutputValue</code> has a solution for. It uses the <code>io-ts</code> library to serialize and deserialize structured types.</p>
<pre><code class="language-typescript">export const FirewallInstanceOutput = t.interface(
  {
    id: t.string,
    name: t.string,
    az: t.string,
  },
  'FirewallInstanceOutput',
);

export type FirewallInstanceOutput = t.TypeOf&lt;typeof FirewallInstanceOutput&gt;;

new StructuredOutputValue&lt;FirewallInstanceOutput&gt;(stack, 'Output', {
  type: FirewallInstanceOutput,
  value: {
    instanceId: instance.instanceId,
    name: firewallConfig.name,
    az,
  },
});
</code></pre>
<p>And we can even improve on this a bit more.</p>
<pre><code class="language-typescript">export const CfnFirewallInstanceOutput = createCfnStructuredOutput(FirewallInstanceOutput);

new CfnFirewallInstanceOutput(stack, 'Output', {
  vpcId: vpc.ref,
  vpcName: vpcConfig.name,
});
</code></pre>
<pre><code class="language-typescript">export const FirewallInstanceOutputFinder = createStructuredOutputFinder(FirewallInstanceOutput, () =&gt; ({}));

// Create an OutputFinder
const firewallInstances = FirewallInstanceOutputFinder.findAll({
  outputs,
  accountKey,
});

// Example usage of the OutputFinder
const firewallInstance = firewallInstances.find(i =&gt; i.name === target.name &amp;&amp; i.az === target.az);
</code></pre>
<p>Generally you would place the output type definition inside <code>src/lib/common-outputs</code> along with the output finder. Then in the deployment folder in <code>src/deployments/cdk/deployments</code> you would create an <code>output.ts</code> file where you would define the CDK output type with <code>createCfnStructuredOutput</code>. You would not define the CDK output type in <code>src/lib/common-outputs</code> since that project is also used by runtime code that does not need to know about CDK and CloudFormation.</p>
<h4 id="adding-tags-to-shared-resources-in-destination-account">Adding Tags to Shared Resources in Destination Account<a class="headerlink" href="#adding-tags-to-shared-resources-in-destination-account" title="Permanent link">&para;</a></h4>
<p>There is another special type of output, <code>AddTagsToResourcesOutput</code>. It can be used to attach tags to resources that are shared into another account.</p>
<pre><code class="language-typescript">new AddTagsToResourcesOutput(this, 'OutputSharedResourcesSubnets', {
  dependencies: sharedSubnets.map(o =&gt; o.subnet),
  produceResources: () =&gt;
    sharedSubnets.map(o =&gt; ({
      resourceId: o.subnet.ref,
      resourceType: 'subnet',
      sourceAccountId: o.sourceAccountId,
      targetAccountIds: o.targetAccountIds,
      tags: o.subnet.tags.renderTags(),
    })),
});
</code></pre>
<p>This will add the outputs to the stack in the account that is initiating the resource share.</p>
<p>Next, the state machine step <code>Add Tags to Shared Resources</code> looks for all those outputs. The step will assume the <code>PipelineRole</code> in the <code>targetAccountIds</code> and attach the given tags to the shared resource.</p>
<h3 id="custom-resources">Custom Resources<a class="headerlink" href="#custom-resources" title="Permanent link">&para;</a></h3>
<p>There are different ways to create a custom resource using CDK. See the <a href="#custom-resource">Custom Resource</a> section for more information.</p>
<p>All custom resources have a <code>README.md</code> that demonstrates their usage.</p>
<h4 id="externalizing-aws-sdk">Externalizing <code>aws-sdk</code><a class="headerlink" href="#externalizing-aws-sdk" title="Permanent link">&para;</a></h4>
<p>Some custom resources set the <code>aws-sdk</code> as external dependency and some do not.</p>
<p>Example of setting <code>aws-sdk</code> as external dependency.</p>
<p><code>src/lib/custom-resources/cdk-kms-grant/runtime/package.json</code></p>
<pre><code class="language-json">{
  &quot;externals&quot;: [&quot;aws-lambda&quot;, &quot;aws-sdk&quot;],
  &quot;dependencies&quot;: {
    &quot;aws-lambda&quot;: &quot;1.0.6&quot;,
    &quot;aws-sdk&quot;: &quot;2.631.0&quot;
  }
}
</code></pre>
<p>Example of setting <code>aws-sdk</code> as embedded dependency.</p>
<p><code>src/lib/custom-resources/cdk-guardduty-enable-admin/runtime/package.json</code></p>
<pre><code class="language-json">{
  &quot;externals&quot;: [&quot;aws-lambda&quot;],
  &quot;dependencies&quot;: {
    &quot;aws-lambda&quot;: &quot;1.0.6&quot;,
    &quot;aws-sdk&quot;: &quot;2.711.0&quot;
  }
}
</code></pre>
<p>Setting the <code>aws-sdk</code> library as external is sometimes necessary when a newer <code>aws-sdk</code> version is necessary for the Lambda runtime code. At the time of writing the NodeJS 12 runtime uses <code>aws-sdk</code> version <code>2.631.0</code></p>
<p>For example the method <code>AWS.GuardDuty.enableOrganizationAdminAccount</code> was only introduced in <code>aws-sdk</code> version <code>2.660</code>. That means that Webpack has to embed the <code>aws-sdk</code> version specified in <code>package.json</code> into the compiled JavaScript file. This can be achieved by removing <code>aws-sdk</code> from the <code>external</code> array.</p>
<p><code>src/lib/custom-resources/cdk-kms-grant/runtime/package.json</code></p>
<h4 id="cfn-response">cfn-response<a class="headerlink" href="#cfn-response" title="Permanent link">&para;</a></h4>
<p>This library helps you send a custom resource response to CloudFormation.</p>
<p><code>src/lib/custom-resources/cdk-kms-grant/runtime/src/index.ts</code></p>
<pre><code class="language-typescript">export const handler = errorHandler(onEvent);

async function onEvent(event: CloudFormationCustomResourceEvent) {
  console.log(`Creating KMS grant...`);
  console.log(JSON.stringify(event, null, 2));

  // eslint-disable-next-line default-case
  switch (event.RequestType) {
    case 'Create':
      return onCreate(event);
    case 'Update':
      return onUpdate(event);
    case 'Delete':
      return onDelete(event);
  }
}
</code></pre>
<h4 id="cfn-tags">cfn-tags<a class="headerlink" href="#cfn-tags" title="Permanent link">&para;</a></h4>
<p>This library helps you send attaching tags to resource created in a custom resource.</p>
<h4 id="webpack-base">webpack-base<a class="headerlink" href="#webpack-base" title="Permanent link">&para;</a></h4>
<p>This library defines the base Webpack template to compile custom resource runtime code.</p>
<p><code>src/lib/custom-resources/cdk-kms-grant/runtime/package.json</code></p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;@aws-accelerator/custom-resource-kms-grant-runtime&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;private&quot;: true,
  &quot;scripts&quot;: {
    &quot;prepare&quot;: &quot;webpack-cli --config webpack.config.ts&quot;
  },
  &quot;source&quot;: &quot;src/index.ts&quot;,
  &quot;main&quot;: &quot;dist/index.js&quot;,
  &quot;types&quot;: &quot;dist/index.d.ts&quot;,
  &quot;externals&quot;: [&quot;aws-lambda&quot;, &quot;aws-sdk&quot;],
  &quot;devDependencies&quot;: {
    &quot;@aws-accelerator/custom-resource-runtime-webpack-base&quot;: &quot;workspace:^0.0.1&quot;,
    &quot;@types/aws-lambda&quot;: &quot;8.10.46&quot;,
    &quot;@types/node&quot;: &quot;14.14.31&quot;,
    &quot;ts-loader&quot;: &quot;7.0.5&quot;,
    &quot;typescript&quot;: &quot;3.8.3&quot;,
    &quot;webpack&quot;: &quot;4.42.1&quot;,
    &quot;webpack-cli&quot;: &quot;3.3.11&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@aws-accelerator/custom-resource-runtime-cfn-response&quot;: &quot;workspace:^0.0.1&quot;,
    &quot;aws-lambda&quot;: &quot;1.0.6&quot;,
    &quot;aws-sdk&quot;: &quot;2.668.0&quot;
  }
}
</code></pre>
<p><code>src/lib/custom-resources/cdk-ec2-image-finder/runtime/webpack.config.ts</code></p>
<pre><code class="language-typescript">import { webpackConfigurationForPackage } from '@aws-accelerator/custom-resource-runtime-webpack-base';
import pkg from './package.json';

export default webpackConfigurationForPackage(pkg);
</code></pre>
<h2 id="workarounds">Workarounds<a class="headerlink" href="#workarounds" title="Permanent link">&para;</a></h2>
<h3 id="stacks-with-same-name-in-different-regions">Stacks with Same Name in Different Regions<a class="headerlink" href="#stacks-with-same-name-in-different-regions" title="Permanent link">&para;</a></h3>
<p>The reason we're creating a <code>cdk.App</code> per account and per region and per phase is because stack names across environments might overlap, and at the time of writing, the CDK CLI does not handle stacks with the same name well. For example, when there is a stack <code>Phase1</code> in <code>us-east-1</code> and another stack <code>Phase1</code> in <code>ca-central-1</code>, the stacks will both be synthesized by CDK to the <code>cdk.out/Phase1.template.json</code> file and one stack will overwrite another's output. Using multiple <code>cdk.App</code>s overcomes this issues as a different <code>outdir</code> can be set on each <code>cdk.App</code>. These <code>cdk.App</code>s are managed by the <code>AccountStacks</code> abstraction.</p>
<h2 id="local-development">Local Development<a class="headerlink" href="#local-development" title="Permanent link">&para;</a></h2>
<h3 id="local-installer-stack">Local Installer Stack<a class="headerlink" href="#local-installer-stack" title="Permanent link">&para;</a></h3>
<p>Use CDK to synthesize the CloudFormation template.</p>
<pre><code class="language-sh">cd src/installer/cdk
pnpx cdk synth
</code></pre>
<p>The installer template file is now in <code>cdk.out/AcceleratorInstaller.template.json</code>. This file can be used to install the installer stack.</p>
<p>You can also deploy the installer stack directly from the command line but then you'd have to pass some stack parameters. See <a href="https://docs.aws.amazon.com/cdk/latest/guide/parameters.html#parameters_deploy">CDK documentation: Deploying with parameters</a>.</p>
<pre><code class="language-sh">cd accelerator/installer
pnpx cdk deploy --parameters GithubBranch=main --parameters ConfigS3Bucket=ASEA-myconfigbucket
</code></pre>
<h3 id="local-initial-setup-stack">Local Initial Setup Stack<a class="headerlink" href="#local-initial-setup-stack" title="Permanent link">&para;</a></h3>
<p>There is a script called <code>cdk.sh</code> in <code>src/core/cdk</code> that allows you to deploy the Initial Setup stack.</p>
<p>The script sets the required environment variables and makes sure all workspace projects are built before deploying the CDK stack.</p>
<h3 id="phase-stacks">Phase Stacks<a class="headerlink" href="#phase-stacks" title="Permanent link">&para;</a></h3>
<p>There is a script called <code>cdk.sh</code> in <code>src/deployments/cdk</code> that allows you to deploy a phase stack straight from the command-line without having to deploy the Initial Setup stack first.</p>
<p>The script enables development mode which means that accounts, organizations, configuration, limits and outputs will be loaded from the local environment instead of loading the values from DynamoDB. The local files that need to be available in the <code>src/deployments/cdk</code> folder are the following.</p>
<ol>
<li><code>accounts.json</code> based on <code>accelerator/accounts</code> (-Parameters table)</li>
</ol>
<pre><code class="language-json">[
  {
    &quot;key&quot;: &quot;shared-network&quot;,
    &quot;id&quot;: &quot;000000000001&quot;,
    &quot;arn&quot;: &quot;arn:aws:organizations::000000000000:account/o-0123456789/000000000001&quot;,
    &quot;name&quot;: &quot;myacct-ASEA-shared-network&quot;,
    &quot;email&quot;: &quot;myacct+ASEA-mandatory-shared-network@example.com&quot;,
    &quot;ou&quot;: &quot;core&quot;
  },
  {
    &quot;key&quot;: &quot;operations&quot;,
    &quot;id&quot;: &quot;000000000002&quot;,
    &quot;arn&quot;: &quot;arn:aws:organizations::000000000000:account/o-0123456789/000000000002&quot;,
    &quot;name&quot;: &quot;myacct-ASEA-operations&quot;,
    &quot;email&quot;: &quot;myacct+ASEA-mandatory-operations@example.com&quot;,
    &quot;ou&quot;: &quot;core&quot;
  }
]
</code></pre>
<ol>
<li><code>organizations.json</code> based on <code>accelerator/organizations</code> (-Parameters table)</li>
</ol>
<pre><code class="language-json">[
  {
    &quot;ouId&quot;: &quot;ou-0000-00000000&quot;,
    &quot;ouArn&quot;: &quot;arn:aws:organizations::000000000000:ou/o-0123456789/ou-0000-00000000&quot;,
    &quot;ouName&quot;: &quot;core&quot;,
    &quot;ouPath&quot;: &quot;core&quot;
  },
  {
    &quot;ouId&quot;: &quot;ou-0000-00000001&quot;,
    &quot;ouArn&quot;: &quot;arn:aws:organizations::000000000000:ou/o-0123456789/ou-0000-00000001&quot;,
    &quot;ouName&quot;: &quot;prod&quot;,
    &quot;ouPath&quot;: &quot;prod&quot;
  }
]
</code></pre>
<ol>
<li><code>limits.json</code> based on <code>accelerator/limits</code> (-Parameters table)</li>
</ol>
<pre><code class="language-json">[
  {
    &quot;accountKey&quot;: &quot;shared-network&quot;,
    &quot;limitKey&quot;: &quot;Amazon VPC/VPCs per Region&quot;,
    &quot;serviceCode&quot;: &quot;vpc&quot;,
    &quot;quotaCode&quot;: &quot;L-F678F1CE&quot;,
    &quot;value&quot;: 15,
    &quot;region&quot;: &quot;ca-central-1&quot;
  },
  {
    &quot;accountKey&quot;: &quot;shared-network&quot;,
    &quot;limitKey&quot;: &quot;Amazon VPC/Interface VPC endpoints per VPC&quot;,
    &quot;serviceCode&quot;: &quot;vpc&quot;,
    &quot;quotaCode&quot;: &quot;L-29B6F2EB&quot;,
    &quot;value&quot;: 50,
    &quot;region&quot;: &quot;ca-central-1&quot;
  }
]
</code></pre>
<ol>
<li><code>outputs.json</code> based on the -Outputs table</li>
</ol>
<pre><code class="language-json">[
  {
    &quot;accountKey&quot;: &quot;shared-network&quot;,
    &quot;outputKey&quot;: &quot;DefaultBucketOutputC7CE5936&quot;,
    &quot;outputValue&quot;: &quot;{\&quot;type\&quot;:\&quot;AccountBucket\&quot;,\&quot;value\&quot;:{\&quot;bucketArn\&quot;:\&quot;arn:aws:s3:::ASEA-sharednetwork-phase1-cacentral1-18vq0emthri3h\&quot;,\&quot;bucketName\&quot;:\&quot;ASEA-sharednetwork-phase1-cacentral1-18vq0emthri3h\&quot;,\&quot;encryptionKeyArn\&quot;:\&quot;arn:aws:kms:ca-central-1:0000000000001:key/d54a8acb-694c-4fc5-9afe-ca2b263cd0b3\&quot;,\&quot;region\&quot;:\&quot;ca-central-1\&quot;}}&quot;
  }
]
</code></pre>
<ol>
<li><code>context.json</code> that contains the default values for values that are otherwise passed as environment variables.</li>
</ol>
<pre><code class="language-json">{
  &quot;acceleratorName&quot;: &quot;ASEA&quot;,
  &quot;acceleratorPrefix&quot;: &quot;ASEA-&quot;,
  &quot;acceleratorExecutionRoleName&quot;: &quot;ASEA-PipelineRole&quot;,
  &quot;defaultRegion&quot;: &quot;ca-central-1&quot;
}
</code></pre>
<ol>
<li><code>config.json</code> that contains the Accelerator configuration.</li>
</ol>
<p>The script also sets the default execution role to allow CDK to assume a role in subaccounts to deploy the phase stacks.</p>
<p>Now that you have all the required local files you can deploy the phase stacks using <code>cdk.sh</code>.</p>
<pre><code class="language-bash">cd src/deployments/cdk
./cdk.sh deploy --phase 1                             # deploy all phase 1 stacks
./cdk.sh deploy --phase 1 --parallel                  # deploy all phase 1 stacks in parallel
./cdk.sh deploy --phase 1 --account shared-network    # deploy phase 1 stacks for account shared-network in all regions
./cdk.sh deploy --phase 1 --region ca-central-1       # deploy phase 1 stacks for region ca-central-1 for all accounts
./cdk.sh deploy --phase 1 --account shared-network --region ca-central-1 # deploy phase 1 stacks for account shared-network and region ca-central
</code></pre>
<p>Other CDK commands are also available.</p>
<pre><code class="language-bash">cd src/deployments/cdk
./cdk.sh bootstrap --phase 1
./cdk.sh synth --phase 1
</code></pre>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<p>We use <code>jest</code> for unit testing. There are no integration tests but this could be set-up by configuring the <code>Installer</code> CodePipeline to have a webhook on the repository and deploying changes automatically.</p>
<p>To run unit tests locally you can run the following command in the monorepo.</p>
<pre><code class="language-bash">pnpx recursive run test -- --pass-with-no-tests --silent
</code></pre>
<p>See CDK's documentation on <a href="https://docs.aws.amazon.com/cdk/latest/guide/testing.html">Testing constructs</a> for more information on how to tests CDK constructs.</p>
<h3 id="validating-immutable-property-changes-and-logical-id-changes">Validating Immutable Property Changes and Logical ID Changes<a class="headerlink" href="#validating-immutable-property-changes-and-logical-id-changes" title="Permanent link">&para;</a></h3>
<p>The most important unit test in this project is one that validates that logical IDs and immutable properties do not change unexpectedly. To avoid the issues described in section <a href="#resource-names-and-logical-ids">Resource Names and Logical IDs</a>, <a href="#changing-logical-ids">Changing Logical IDs</a> and <a href="#changing-immutable-properties">Changing (Immutable) Properties</a>.</p>
<p>This test can be found in the <code>src/deployments/cdk/test/apps/unsupported-changes.spec.ts</code> file. It synthesizes the <code>Phase</code> stacks using mocked outputs and uses <a href="https://jestjs.io/docs/en/snapshot-testing"><code>jest</code> snapshots</a> to compare against future changes.</p>
<p>The test will fail when changing immutable properties or changing logical IDs of existing resources. In case the changes are expected then the snapshots will need to be updated. You can update the snapshots by running the following command.</p>
<pre><code class="language-sh">pnpx run test -- -u
</code></pre>
<p>See <a href="#accept-unit-test-snapshot-changes">Accept Unit Test Snapshot Changes</a>.</p>
<h3 id="upgrade-cdk">Upgrade CDK<a class="headerlink" href="#upgrade-cdk" title="Permanent link">&para;</a></h3>
<p>There's a test in the file <code>src/deployments/cdk/test/apps/unsupported-changes.spec.ts</code> that is currently commented out. The test takes a snapshot of the whole <code>Phase</code> stack and compares the snapshot to changes in the code.</p>
<pre><code class="language-typescript">test('templates should stay exactly the same', () =&gt; {
  for (const [stackName, resources] of Object.entries(stackResources)) {
    // Compare the relevant properties to the snapshot
    expect(resources).toMatchSnapshot(stackName);
  }
});
</code></pre>
<p>Before upgrading CDK we uncomment this test. We run the test to update all the snapshots. Then we update all CDK versions and run the test again to compare the snapshots with the code using the new CDK version. If the test passes, then the upgrade should be stable.</p>
<blockquote>
<p><em>Action Item:</em> Automate this process.</p>
</blockquote>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Accelerator Developer Guide" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Accelerator Developer Guide
            </div>
          </div>
        </a>
      
      
        
        <a href="../tech-stack/" class="md-footer__link md-footer__link--next" aria-label="Next: Tech Stack" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Tech Stack
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.sections", "navigation.instant", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.960e086b.min.js"></script>
      
    
  </body>
</html>