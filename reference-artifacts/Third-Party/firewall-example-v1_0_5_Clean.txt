config system global
  set hostname ${Hostname}
  set admintimeout 60
  set vdom-mode split-vdom
end
config system settings
  set allow-subnet-overlap enable
end
config global
  config system interface
    edit port1
      set vdom FG-traffic
      set alias public
      set mode static
      set ip ${PublicIp1} ${PublicMask}
      set allowaccess ping https ssh fgfm
      set secondary-IP enable
      set mtu-override enable
      set mtu 9001
    next
    edit port2
      set vdom FG-traffic
      set alias private
      set mode static
      set ip ${PrivateIp1} ${PrivateMask}
      set allowaccess ping
      set mtu-override enable
      set mtu 9001
    next
    edit port3
      set vdom root
      set alias mgmt
      set mode static
      set ip ${FWMgmtIp1} ${FWMgmtMask}
      set allowaccess ping https ssh fgfm
      set mtu-override enable
      set mtu 9001
    next
    edit port4
      set vdom FG-traffic
      set alias DMZ
      set mode static
      set ip ${ProxyIp1} ${ProxyMask}
      set allowaccess ping
      set mtu-override enable
      set mtu 9001
    next
  end
end
config vdom
  edit FG-traffic
  config router static
    edit 1
      set device port1
      set gateway ${PublicRouterIp}
    next
    edit 2
      set dst ${VpcNetworkIp} ${VpcMask}
      set device port2
      set gateway ${PrivateRouterIp}
    next
    edit 3
      set dst ${FWMgmtNetworkIp} ${FWMgmtMask}
      set device port2
      set gateway ${PrivateRouterIp}
    next
  end
  next
  edit root
  config router static
    edit 1
      set device port3
      set gateway ${FWMgmtRouterIp}
    next
  end
end
config vdom
  edit FG-traffic
  config vpn ipsec phase1-interface
    edit "tgw-vpn1"
      set interface "port1"
      set local-gw ${PublicIp1}
      set keylife 28800
      set peertype any
      set proposal aes256-sha256
      set dhgrp 2
      set remote-gw ${PublicVpnTunnelOutsideAddress1}
      set psksecret ${PublicPreSharedSecret1}
      set dpd-retryinterval 10
    next
  end
  config vpn ipsec phase2-interface
    edit "tgw-vpn1"
      set phase1name "tgw-vpn1"
      set proposal aes256-sha256
      set dhgrp 2
      set keylifeseconds 3600
    next
  end
  config system interface
    edit "tgw-vpn1"
      set ip ${PublicCgwTunnelInsideAddress1} 255.255.255.255
      set remote-ip ${PublicVpnTunnelInsideAddress1} 255.255.255.255
    next
  end
  config firewall ippool
    edit "cluster-ippool"
      set startip ${PublicIp1}
      set endip ${PublicIp1}
    next
  end
  config firewall internet-service-group
    edit "GROUP-Fortinet-ISDB"
        set direction destination
        set member 1245187 1245326 1245324 1245325 1245191 1245186 1245193 1245198 1245208 1245199 1245192 1245184 1245188 1245200 1245190 1245185
    next
  end
  config firewall policy
    edit 3
      set name "in-vpn"
      set srcintf "tgw-vpn1"
      set dstintf "port2"
      set srcaddr "all"
      set dstaddr "all"
      set action accept
      set schedule "always"
      set service "ALL"
      set logtraffic all
      set fsso disable
    next
    edit 2
      set name "out-vpn"
      set srcintf "port2"
      set dstintf "tgw-vpn1"
      set srcaddr "all"
      set dstaddr "all"
      set action accept
      set schedule "always"
      set service "ALL"
      set logtraffic all
      set fsso disable
    next
    edit 1
      set name "outbound-all"
      set srcintf "port2"
      set dstintf "port1"
      set srcaddr "all"
      set dstaddr "all"
      set action accept
      set schedule "always"
      set service "ALL"
      set logtraffic all
      set ippool enable
      set poolname "cluster-ippool"
      set nat enable
    next
    edit 4
      set name "Fortinet-activation-traffic"
      set srcintf "port2"
      set dstintf "port1"
      set srcaddr "all"
      set internet-service enable
      set internet-service-group "GROUP-Fortinet-ISDB"
      set action accept
      set schedule "always"
      set nat enable
    next
    edit 5
        set name "Outbound Internet"
        set srcintf "tgw-vpn1"
        set dstintf "port1"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "certificate-inspection"
        set av-profile "g-default"
        set webfilter-profile "g-default"
        set dnsfilter-profile "default"
        set ips-sensor "g-default"
        set application-list "g-default"
        set logtraffic all
        set nat enable
    next
  end
  config router prefix-list
    edit "pflist-default-route"
    config rule
      edit 1
        set prefix 0.0.0.0 0.0.0.0
        unset ge
        unset le
      next
    end
    next
    edit "pflist-port1-ip"
    config rule
      edit 1
        set prefix ${PublicIp1} 255.255.255.255 # 100.96.251.69
        unset ge
        unset le
      next
    end
    next
  end
  config router route-map
    edit "rmap-outbound"
    config rule
      edit 1
        set match-ip-address "pflist-default-route"
      next
      edit 2
        set match-ip-address "pflist-port1-ip"
      next
    end
    next
  end
  config router bgp
    set as ${PublicCgwBgpAsn1}
    set router-id ${PublicIp1}
    set ebgp-multipath enable
    set network-import-check disable
    config neighbor
      edit ${PublicVpnTunnelInsideAddress1}
        set capability-default-originate enable
        set remote-as ${PublicVpnBgpAsn1}
        set route-map-out "rmap-outbound"
        set link-down-failover enable
      next
    end
    config network
      edit 1
        set prefix ${PublicIp1} 255.255.255.255
      next
      edit 2
        set prefix ${PrivateNetworkIp} ${PrivateMask}
      next
    end
  end
  
end